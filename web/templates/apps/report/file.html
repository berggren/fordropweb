{% extends "apps/report/report_base.html" %}
{% load comments %}
{% load thumbnail %}

{% block extrahead %}
<script>
    $(document).ready(function() {
        $("#button_block").hide()
        $("#id_comment").focus(function() {
            $(this).animate({"height": "85px"}, "fast" );
            $("#button_block").slideDown("fast");
            return false;
        });
        $("#button_cancel").click(function() {
            $("#id_comment").animate({"height": "18px"}, "fast" );
            $("#button_block").slideUp("fast");
            return false;
        });
        $("#editref").click(function() {
            $("#ref").remove();
            $(this).replaceWith("<form method='post' action='/reference/add/file/{{ resultme.id }}'> {% csrf_token %}<input class='left' style='width:310px;margin-top:3px;margin-left:10px;' type=text name='reference'></input><input type=submit value='Change' class='btn right' style='margin-top:3px;'></form>");
        });
    });
</script>
{% endblock %}

{% block report_leftside %}

{% if messages %}
    {% for message in messages %}
        <div class="alert-message warning">
            <a class="close" href="#">Ã—</a>
            <p>
                <strong>{{ message }}</strong>
            </p>
        </div>
    {% endfor %}
{% endif %}

<!--<a href="javascript: history.go(-1)" style="margin-right:10px;" class="btn left">&laquo; Back</a><h3 class="inline">{{ result.sha1 }}</h3>-->
<ul class="tabs">
    <li class="active"><a href="/file/{{ result.id }}/show">Info</a></li>
    <li><a href="/file/{{ result.id }}/related">Related</a></li>
    <li><a href="/file/{{ result.id }}/graph"">Graph</a></li>
    <li><a href="/file/{{ result.id }}/wiki">Wiki</a></li>
</ul>

{% if investigations %}
<div class="alert-message block-message info">
    <!-- <a class="close" href="#">&times;</a> -->
    <h3>Appears in the following investigations</h3>
    {% for investigation in investigations %}
        <a href="/investigation/{{ investigation.id }}" class="btn" style="margin-top:5px;">{{  investigation.title }}</a>
    {% endfor %}
</div>
{% endif %}

<div class="well">
    <table border=0>
	    <tr><td><b>Type:</b></td><td>{{ result.filetype }}</td></tr>
		<tr><td><b>Size:</b></td><td>{{ result.filesize }} bytes ({{ result.filesize|filesizeformat }})</td></tr>
		<tr><td><b>md5:</b></td><td>{{ result.md5 }}</td></tr>
		<tr><td><b>sha1:</b></td><td>{{ result.sha1 }}</td></tr>
		<tr><td><b>sha256:</b></td><td>{{ result.sha256 }}</td></tr>
        <tr><td><b>MHR</b></td>
        <td>
            {% if not mhr %}
	            <a href="/file/{{ result.id }}/malware/mhr?hash={{ result.sha1 }}">Check with MHR (Malware Hash Repository)</a><br>
	        {% else %}
	            {% if mhr.donotexist %}
		            <font color="green">No match in MHR:s malware repository</font><br>
	            {% else %}
	                <font color="red">{{ mhr.percent }}% chance this file is malware according to MHR</font><br>
	            {% endif %}
            {% endif %}
        </td></tr>
    </table>
    {% if resultme %}
    {% if not resultme.reference %}
        <h3 class="left">Add reference</h3>
        <form method="post" action="/reference/add/file/{{ resultme.id }}"> {% csrf_token %}
            <input class="left" style="width:340px;margin-top:3px;margin-left:10px;" type='text' name="reference"></input>
            <input type='submit' value="Add" class="btn right" style="margin-top:3px;"></input>
        </form>
    {% else %}
            <h6 class="left" style="margin-right:10px;">Your reference</h6><h3 class="left" id="ref">{{ resultme.reference }}</h3>
            <a href="#" class="right" id="editref" style="margin-top:8px;">Edit</a>
    {% endif %}

    {% endif %}
    <br><br>
</div>


{% if files %}
    <div class="well">
        <table border=0>
            <th>{{ files|length }} reporter{{ files|pluralize:"s"  }}</th>
            <th>filename</th>
            <th>reference</th>
            {% for n in files %}
                <tr>
                    <td width="200px"><div class="avatar"><img class="avatar-thumb" src={% thumbnail n.user.get_profile.avatar 32x32 crop %}></div>
                        <span class="threadTitle"><a href="/user/{{ n.user.id }}">{{ n.user.get_full_name }}</a></span><br>
                        <span class="threadText">{{ n.timecreated|timesince }} ago</span><br><br>
                        <td>{{ n.filename }}</td>
                        {% if n.reference %}
                            <td><a href="/search/reference?r={{ n.reference.id }}">{{ n.reference }}</a></td>
                        {% else %}
                            <td></td>
                        {% endif %}
                </tr>
            {% endfor %}
        </table>
{% endif %}
</div>
{% endblock %}

{% block report_rightside %}
<!-- Comments -->
<br>
{% get_comment_list for result as comments %}
{% get_comment_form for result as form %}
<form method="post" action="/comments/post/">{% csrf_token %}
    <input type="hidden" name="next" value="/file/{{ result.id }}/show" />
        {% for hidden in form.hidden_fields %}
            {{ hidden }}
        {% endfor %}
        <textarea rows=1 id="id_comment" name="comment" placeholder="Comment"></textarea>
        <br><br>
        <div id="button_block">
            <input type="submit" class="btn primary" id="button_submit" value="Post" />
            <input type="submit" class="btn" id='button_cancel' value="Cancel" />
     </div>
</form>

{% if comments %}
    {% for comment in comments %}
        <div class="comment-container">
            <div class="comment">
                <div class="avatar"><img class="avatar-thumb" src={% thumbnail comment.user.get_profile.avatar 32x32 crop %}></div>
                <a href="/user/{{ comment.user.id }}">{{ comment.user.first_name }} {{ comment.user.last_name }}</a><br>
                <span class="quiet">{{ comment.submit_date|timesince }} ago</span><br>
                {{ comment.comment|linebreaksbr }}
                <br><br><hr>
            </div>
        </div>
    {% endfor %}
{% else %}
    <h6>No comments</h6>
{% endif %}
<!-- END comments -->
{% endblock %}
