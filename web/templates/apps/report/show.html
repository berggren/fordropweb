{% extends "apps/report/report_base.html" %}
{% load comments %}
{% load threadedcomments_tags %}
{% load thumbnail %}

{% block report_submenu %}
    <li><a href="#" title="" class="current">Overview</a></li>
    <li><a href="#" title="">Upload file</a></li>
    <li><a href="#" title="">Report</a></li>
    <li><a href="#" title="">Browse</a></li>
{% endblock %}

<div id="rightbox">
  <br>
  <h1>Metadata</h1>
  <b>Tags:</b> {% for tag in tags %}<i><a href="/search/tag?t={{ tag.id }}">{{ tag }}</a></i> {% endfor %}
  <form action="/tag/add/report/{{ result.id }}" method="post" enctype="multipart/form-data" width="450px">{% csrf_token %}
    {% for field in tagform %}
          {{ field.errors }}
          {{ field }}
        {% endfor %}
      <input type="submit" value="Add tag" />
  </form>

{% if resultme %}
  {% ifequal resultme.reference None %}
  <b>Reference:</b>
  <form action="/reference/add/report/{{ resultme.id }}" method="post" enctype="multipart/form-data" width="450px">{% csrf_token %}
    {% for field in referenceform %}
          {{ field.errors }}
          {{ field }}
        {% endfor %}
      <input type="submit" value="Save" />
    </form>
    {% else %}
    <div onclick="$(this).next('div.#hidetext').toggle('fast')" style="cursor:pointer;"><b>Reference:</b> <i>{{ resultme.reference }}</i> [Edit]</div>
      <div id="hidetext" style="display:none;">
        <form action="/reference/add/report/{{ resultme.id }}" method="post" enctype="multipart/form-data" width="450px">{% csrf_token %}
          {% for field in referenceform %}
                {{ field.errors }}
                {{ field }}
              {% endfor %}
            <input type="submit" value="Save" />
          </form>
      </div>  
      <br>
  {% endifequal %}
{% endif %}
</div>

<div id="breadcrumbs"> 
  <ul> 
    <li class="breadcrumblink"><a href="/upload">Upload & Report</a></li> 
    <li class="breadcrumblink">{{ result.type }}</li>
    <li>{{ result.value }}</li>
  </ul> 
  <hr>
</div>

<div id="middlebox">
          {% if messages %}
          {% for message in messages %}
           <div{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</div>
          {% endfor %}
          <br>
        {% endif %}

	<h1>Info for {{ result.type.name }} {{ result.value }}</h1>
	<div class="news_box_grey">
		<table border=0>
			<tr><td><b>Value:</b></td><td>{{ result.value }}</td></tr>
			<tr><td><b>md5:</b></td><td>{{ result.md5 }}</td></tr>
			<tr><td><b>sha1:</b></td><td>{{ result.sha1 }}</td></tr>
			<tr><td><b>sha256:</b></td><td>{{ result.sha256 }}</td></tr>
		</table>
	</div>

  <br>

	{% if resultall %}
    <div class="news_box_grey">


		<table border=0>
			<th></th>
			<th>Value</th>
			<th>Type</th>
			<th>Reference</th>
			{% for n in resultall %}
        <tr>
          <td width="200px"><div class="avatar"><img class="avatar-thumb" src={% thumbnail n.user.get_profile.avatar 32x32 crop %}></div>
          <span class="threadTitle"><a href="/user/{{ n.user.id }}">{{ n.user.get_full_name }}</a></span><br>
          <span class="threadText">{{ n.timecreated|timesince }} ago</span><br><br>
          <td>{{ n.report.value }}</td>
          <td>{{ n.report.type }}</td>
          {% if n.reference %}
            <td><a href="/search/reference?r={{ n.reference.id }}">{{ n.reference }}</a></td>
          {% else %}
            <td></td>
          {% endif %}
        </tr>
			{% endfor %}
		</table>
  </div>

	{% endif %}

  <br>

	{% get_comment_count for result as comment_count %}
	{% if comment_count %}
		<h1>{{ comment_count }} comments</h1>
		<hr>
	{% endif %}
	{% get_comment_list for result as comment_list %}
	{% for comment in comment_list|fill_tree|annotate_tree %}
		{% ifchanged comment.parent_id %}{% else %}
		    </li>
		{% endifchanged %}
	
		{% if not comment.open and not comment.close %}
		    </li>
		{% endif %}
	    
		{% if comment.open %}
			{% if not comment.parent_id %}
		    	<ul class="comment-root">
		    {% else %}
		    	<ul class="comment-sub">
		    {% endif %}
		{% endif %}
	
		<li>
		
		<div class="comment-container">
			<div class="comment">
				<div class="avatar"><img class="avatar-thumb" src={% thumbnail comment.user.get_profile.avatar 32x32 crop %}></div>
				<span class="threadTitle"><a href="/user/{{ comment.user.id }}">{{ comment.user.first_name }} {{ comment.user.last_name }}</a></span><br>
				<span class="threadText">{{ comment.submit_date|timesince }} ago</span><br><br>
				{{ comment.comment|linebreaksbr }}
				{% get_comment_form for result as form with comment.id %}
				<br><br>
				<div onclick="$(this).next('div.#hidetext').toggle('fast')" style="cursor:pointer;">
					<font color="blue">Reply</font>
				</div>
				<div id="hidetext" style="display:none;">
					<form action="/comments/post/" method="post">{% csrf_token %}
						<input type="hidden" name="next" value="/report/{{ result.id }}/show" />
						{% for hidden in form.hidden_fields %}
		       				{{ hidden }}
		    			{% endfor %}
						{{ form.comment }}
						<br>
		  				<input type="submit" value="Post">
					</form>
				</div>
			</div>
	   	</div>

		{% for close in comment.close %}
		    </li>
		    </ul>
		{% endfor %}
	{% endfor %}

	<div class="box_color">
	<h1>Write a comment</h1>
	<br>
		{% get_comment_form for result as form %}
		<form action="/comments/post/" method="post">{% csrf_token %}
			<input type="hidden" name="next" value="/report/{{ result.id }}/show" />
			{% for hidden in form.hidden_fields %}
	        	{{ hidden }}
	    	{% endfor %}
			{{ form.comment }}
			<br>
	  		<input type="submit" value="Post">
		</form>
	</div>
	
</div>



{% endblock %}