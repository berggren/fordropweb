var XMPP={CONFIG_FILE:"/site_media/pubsubbox/js/klutt_config.js",connection:null,my_jid:null,nodes:{},roster:{},domains:[],notifications:0,disco_nodes:{},jid_to_id:function(a){return Strophe.getBareJidFromJid(a).replace(/@/g,"-").replace(/\./g,"-")},jid_without_at:function(a){return Strophe.getBareJidFromJid(a).replace(/@/g," ")},on_add_to_whitelist:function(c,a){var b=$iq({to:XMPP.pubsubservice,type:"set"}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub#owner"}).c("affiliations",{node:c}).c("affiliation",{jid:a,affiliation:"member"});XMPP.connection.sendIQ(b)},remove_from_whitelist:function(c,a){var b=$iq({to:XMPP.pubsubservice,type:"set"}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub#owner"}).c("affiliations",{node:c}).c("affiliation",{jid:a,affiliation:"none"});XMPP.connection.sendIQ(b,XMPP.on_remove_from_whitelist(c))},on_remove_from_whitelist:function(a){setTimeout(function(){$(document).trigger("node_update_subscriber_count",{id:a})},50)},delete_node:function(b){console.log("delete node "+b);var a=$iq({to:XMPP.pubsubservice,type:"set"}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub#owner"}).c("delete",{node:b});$("#"+b).remove();XMPP.connection.sendIQ(a,XMPP.on_whitelist)},on_roster:function(a){$("#roster").empty();$(a).find("item").each(function(){var m=$(this).attr("subscription");if(m==="both"||m==="from"){var e=$(this).attr("jid");var g=e.split("@")[1];var d=XMPP.jid_to_id(e);var b=$(this).attr("name")||XMPP.jid_without_at(e);XMPP.roster[e]=b;var l=b.split(" ");var k=l[0]||"";var h=l[1]||"";var f=$('<div class="drag box_roster left" jid="'+e+'" id="'+d+'"><span class="'+d+'-canvas"></span><span>'+k+"<br>"+h+"</span></div>");$("#roster").append(f);var c=$iq({to:e,type:"get"}).c("vCard",{xmlns:"vcard-temp"});XMPP.connection.sendIQ(c,XMPP.on_vcard,XMPP.on_error);if($.inArray(g,XMPP.domains)===-1){XMPP.domains.push(g);var j="pubsub."+g;var i=$iq({to:j,type:"get"}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("affiliations");XMPP.connection.sendIQ(i,XMPP.on_pubsub_disco,XMPP.on_error)}}});XMPP.connection.send($pres())},on_pubsub_disco:function(d){var b=$(d).attr("from");var c=[];$(d).find("affiliation").each(function(){if($(this).attr("affiliation")==="member"){c.push($(this).attr("node"))}});XMPP.disco_nodes[b]=c;$("#discovery").append("<h3>"+b+"</h3>");for(var e in c){$("#discovery").append('<span id="'+c[e]+'-disco">'+c[e]+'</span><span id="'+c[e]+'-disco-state" class="label success right">subscribe&nbsp;&nbsp;&nbsp;&nbsp;</span><br><br>')}var a=$iq({to:b,type:"get"}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("subscriptions");XMPP.connection.sendIQ(a,XMPP.on_get_subscriptions,XMPP.on_error)},on_get_subscriptions:function(a){$(a).find("subscription").each(function(){$("#"+$(this).attr("node")+"-disco-state").replaceWith('<span class="label right">unsubscribe</span>')})},on_roster_changed:function(b){var a=$iq({type:"get"}).c("query",{xmlns:"jabber:iq:roster"});XMPP.connection.sendIQ(a,XMPP.on_roster)},update_notification_count:function(a){if(a==="plus"){XMPP.notifications=XMPP.notifications+1}else{XMPP.notifications=XMPP.notifications-1}if(XMPP.notifications===0){$("#notification_count").hide();$("#subscription_request").hide()}else{$("#notification_count").replaceWith('<span class="label important hidden" id="notification_count">'+XMPP.notifications+"</span>");$("#notification_count").show()}},on_presence:function(c){var d=$(c).attr("type");var h=$(c).attr("from");var g=Strophe.getBareJidFromJid(h);if(d==="subscribe"){var b=XMPP.jid_to_id(g)+"-subscription_request";var a=XMPP.jid_to_id(g)+"-subscription_allow";var f=XMPP.jid_to_id(g)+"-subscription_deny";var e='<tr id="'+b+'"><td>'+g+'</td><td><button class="btn success" id="'+a+'">Yes</button></td><td><span class="btn error" id="'+f+'">No</span></td></tr>';$("#subscription_request").show();$("#subscription_request_table").append(e);XMPP.update_notification_count("plus");$("#"+a).click(function(){XMPP.connection.send($pres({to:g,type:"subscribed"}));XMPP.connection.send($pres({to:g,type:"subscribe"}));$("#"+b).remove();XMPP.update_notification_count("minus")});$("#"+f).click(function(){XMPP.connection.send($pres({to:g,type:"unsubscribed"}));$("#"+b).remove();XMPP.update_notification_count("minus")})}return true},on_message:function(c){var a=$(c).attr("from");var b=$(c).find("items").attr("node");$(c).find("item").each(function(){var d=$(this).find("event").text();$("#activities").append('<span class="alert-message warning"><strong>'+a+"</strong> ("+b+") "+d+"</span><br><br>")});return true},on_vcard:function(g){var e=$(g).find("vCard");var b=$(g).attr("from");var a=XMPP.jid_to_id(b);var c=a+"-avatar";$("."+a+"-canvas").append('<canvas id="'+c+'" width="48" height="48"></canvas><br>');var f=e.find("BINVAL").text();var i=e.find("TYPE").text();var h="data:"+i+";base64,"+f;var j=$("#"+c).get(0).getContext("2d");var d=new Image();d.onload=function(){j.drawImage(d,0,0,48,48)};d.src=h;$(".drag").draggable({helper:"clone",appendTo:"body",containment:"html",opacity:"0.85",revert:false,revertDuration:100,stack:".drag",cursor:"move",scroll:false})},on_vcard_node_info:function(g){var e=$(g).find("vCard");var b=$(g).attr("from");var a=XMPP.jid_to_id(b)+"-node_info";var c=a+"-avatar";$("."+a+"-canvas").append('<canvas id="'+c+'" width="48" height="48"></canvas><br>');var f=e.find("BINVAL").text();var i=e.find("TYPE").text();var h="data:"+i+";base64,"+f;var j=$("#"+c).get(0).getContext("2d");var d=new Image();d.onload=function(){j.drawImage(d,0,0,48,48)};d.src=h;$(".drag").draggable({helper:"clone",appendTo:"body",containment:"html",opacity:"0.85",revert:false,revertDuration:100,stack:".drag",cursor:"move",scroll:false})},on_my_vcard:function(f){var e=$(f).find("vCard");var b=e.find("BINVAL").text();var h=e.find("TYPE").text();var g="data:"+h+";base64,"+b;var i=$("#avatar").get(0).getContext("2d");var d=new Image();d.onload=function(){i.drawImage(d,0,0,68,68)};d.src=g;var c=$(f).attr("from");var a=e.find("FN").text()||c;$("#fullname").text(a)},on_pubsub_item:function(b){$(b).find("item").each(function(){if($(this).attr("node")!="/home"){XMPP.nodes[$(this).attr("node")]=$(this).attr("name")}});var a=$iq({to:XMPP.pubsubservice,type:"get"}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("affiliations");XMPP.connection.sendIQ(a,XMPP.on_affiliation,XMPP.on_error)},on_affiliation:function(a){$(a).find("affiliation").each(function(){if($(this).attr("affiliation")==="owner"&&$(this).attr("affiliation")!="outcast"){if(XMPP.nodes[$(this).attr("node")]){var b=$('<div class="box_node drop left" id="'+$(this).attr("node")+'""><strong>'+XMPP.nodes[$(this).attr("node")]+"</strong><br><br></div>");$("#"+$(this).attr("node")).remove();$(document).trigger("node_subscriber_count",{id:$(b).attr("id")});$("#pubsub").append(b);$(b).click(function(){$(".box_node").removeClass("highlight");$(b).addClass("highlight");$(document).trigger("node_info",{id:$(b).attr("id")})});$(".drop").droppable({drop:function(d,e){var c=e.draggable.attr("jid");var f=$(this).attr("id");XMPP.on_add_to_whitelist(f,c);$(document).trigger("node_update_subscriber_count",{id:f})}})}}})},on_node_affiliation:function(a){$("#spinner").hide();$(a).find("affiliation").each(function(){if($(this).attr("affiliation")!="owner"&&$(this).attr("affiliation")!="outcast"){var c=$(this).attr("jid");var i=XMPP.jid_to_id(c)+"-node_info";var b=XMPP.roster[c];var h=b.split(" ");var g=h[0]||"";var f=h[1]||"";var e=$('<div class="box_roster left" id="'+i+'-node_info"><span class="'+i+'-canvas"></span><span>'+g+"<br>"+f+'</span><div class="vcard_remove hidden" id="remove_from_whitelist"></div></div>');$("#node_info_whitelist").append(e);$(e).mouseenter(function(){$(e).find("#remove_from_whitelist").show()});$(e).mouseleave(function(){$(e).find("#remove_from_whitelist").hide()});$(e).find("#remove_from_whitelist").click(function(){var j=$(a).find("affiliations").attr("node");XMPP.remove_from_whitelist(j,c);$(this).parent().empty().hide()});var d=$iq({to:c,type:"get"}).c("vCard",{xmlns:"vcard-temp"});XMPP.connection.sendIQ(d,XMPP.on_vcard_node_info,XMPP.on_error)}})},on_node_subscriber_count:function(c){var b=0;var a=$(c).find("affiliations").attr("node");$(c).find("affiliation").each(function(){if($(this).attr("affiliation")!="owner"&&$(this).attr("affiliation")!="outcast"){b=b+1}});$("#"+a).append('<h1 class="count">'+b+"</h1>")},on_node_update_subscriber_count:function(c){var b=0;var a=$(c).find("affiliations").attr("node");$(c).find("affiliation").each(function(){if($(this).attr("affiliation")!="owner"&&$(this).attr("affiliation")!="outcast"){b=b+1}});$("#"+a).find("h1").replaceWith('<h1 class="count">'+b+"</h1>")},on_create_node_whitelist:function(b){var a=$iq({to:XMPP.pubsubservice,type:"get"}).c("query",{xmlns:"http://jabber.org/protocol/disco#items"});XMPP.connection.sendIQ(a,XMPP.on_pubsub_item,XMPP.on_error)},on_error:function(a){if(XMPPConfig.debug===true){console.log("ERROR, take a look ast the followiung error-stanza:");console.log(a)}}};$(document).bind("connect",function(b,c){var a=new Strophe.Connection("/http-bind");if(XMPPConfig.debug===true){a.xmlInput=function(d){console.log(d)};a.xmlOutput=function(d){console.log(d)}}XMPP.my_jid=c.jid;XMPP.pubsubservice=c.pubsubservice;a.connect(c.jid,c.password,function(d){if(d===Strophe.Status.CONNECTED){$(document).trigger("connected")}else{if(d===Strophe.Status.DISCONNECTED){$(document).trigger("disconnected")}}});XMPP.connection=a});$(document).bind("connected",function(){$("#login_spinner").hide();$("#main-screen").toggle("fast");$("#label-online").toggle("fast");var b=$iq({type:"get"}).c("query",{xmlns:"jabber:iq:roster"});var a=$iq({to:XMPP.pubsubservice,type:"get"}).c("query",{xmlns:"http://jabber.org/protocol/disco#items"});var c=$iq({type:"get"}).c("query",{xmlns:"vcard-temp"});XMPP.connection.addHandler(XMPP.on_presence,null,"presence");XMPP.connection.addHandler(XMPP.on_message,null,"message","headline");XMPP.connection.addHandler(XMPP.on_roster_changed,"jabber:iq:roster","iq","set");XMPP.connection.sendIQ(b,XMPP.on_roster);XMPP.connection.sendIQ(a,XMPP.on_pubsub_item,XMPP.on_error);XMPP.connection.sendIQ(c,XMPP.on_my_vcard,XMPP.on_error)});$(document).bind("disconnected",function(){$("#label-online").removeClass("success").addClass("important").text("Offline");XMPP.connection=null});$(document).bind("create_node_whitelist",function(a,b){var c=$iq({to:XMPP.pubsubservice,type:"set"}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub"}).c("create").up().c("configure").c("x",{xmlns:"jabber:x:data",type:"submit"}).c("field",{"var":"FORM_TYPE",type:"hidden"}).c("value").t("http://jabber.org/protocol/pubsub#node_config").up().up().c("field",{"var":"pubsub#access_model"}).c("value").t("whitelist").up().up().c("field",{"var":"pubsub#title"}).c("value").t(b.node);XMPP.connection.sendIQ(c,XMPP.on_create_node_whitelist)});$(document).bind("add_contact",function(a,b){XMPP.connection.send($pres({to:b.jid,type:"subscribe"}))});$(document).bind("node_subscriber_count",function(b,c){var a=$iq({to:XMPP.pubsubservice,type:"get"}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub#owner"}).c("affiliations",{node:c.id});XMPP.connection.sendIQ(a,XMPP.on_node_subscriber_count,XMPP.on_error)});$(document).bind("node_update_subscriber_count",function(b,c){var a=$iq({to:XMPP.pubsubservice,type:"get"}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub#owner"}).c("affiliations",{node:c.id});XMPP.connection.sendIQ(a,XMPP.on_node_update_subscriber_count,XMPP.on_error)});$(document).bind("node_info",function(b,c){$("#roster").hide();$("#node_info_whitelist").empty().show();$("#node_info_buttonlist").empty().show().append('<button id="button_close_node_info" class="btn">&laquo; Back to roster</button>');$("#node_info_buttonlist").append('<button id="button_delete_node" class="btn error" style="margin-left:10px;">Delete node</button><br><br>');$("#button_delete_node").click(function(){XMPP.delete_node(c.id);$("#node_info").empty().hide();$("#node_info_whitelist").empty().hide();$("#node_info_buttonlist").empty().hide();$(".box_node").removeClass("highlight");$("#roster").fadeIn()});$("#button_close_node_info").click(function(){$("#node_info").empty().hide();$("#node_info_whitelist").empty().hide();$("#node_info_buttonlist").empty().hide();$(".box_node").removeClass("highlight");$("#roster").fadeIn()});var a=$iq({to:XMPP.pubsubservice,type:"get"}).c("pubsub",{xmlns:"http://jabber.org/protocol/pubsub#owner"}).c("affiliations",{node:c.id});XMPP.connection.sendIQ(a,XMPP.on_node_affiliation)});$(document).bind("change_tab",function(a,b){$("#tab_menu").find("li").each(function(){$(this).removeClass("active")});$("#"+b.active_tab).addClass("active")});$(document).bind("manage_tab",function(a){$("#roster_container").show();$("#nodes_container").show();$("#activities_container").hide();$("#notification_container").hide();$("#discovery_container").hide()});$(document).bind("discovery_tab",function(a){$("#roster_container").hide();$("#nodes_container").hide();$("#activities_container").hide();$("#notification_container").hide();$("#discovery_container").show()});$(document).bind("activities_tab",function(a){$("#roster_container").hide();$("#nodes_container").hide();$("#notification_container").hide();$("#discovery_container").hide();$("#activities_container").show()});$(document).bind("notification_tab",function(a){$("#roster_container").hide();$("#nodes_container").hide();$("#activities_container").hide();$("#discovery_container").hide();$("#notification_container").show()});$(document).ready(function(){$("#connect-button").click(function(){$("#login-form").fadeIn()});$("#create-node-button").click(function(){$("#add-node-modal").modal("hide");$(document).trigger("create_node_whitelist",{node:$("#node").val()})});$("#add-contact-button").click(function(){$("#add-contact-modal").modal("hide");$(document).trigger("add_contact",{jid:$("#contact").val()})});$("#activities_link").click(function(){$(document).trigger("change_tab",{active_tab:"activities_tab"});$(document).trigger("activities_tab")});$("#manage_link").click(function(){$(document).trigger("change_tab",{active_tab:"manage_tab"});$(document).trigger("manage_tab")});$("#discovery_link").click(function(){$(document).trigger("change_tab",{active_tab:"discovery_tab"});$(document).trigger("discovery_tab")});$("#notification_link").click(function(){$(document).trigger("change_tab",{active_tab:"notification_tab"});$(document).trigger("notification_tab")});$.getScript(XMPP.CONFIG_FILE,function(){$("#login-button").click(function(){$(document).trigger("connect",{jid:XMPPConfig.jid,pubsubservice:XMPPConfig.pubsubservice,password:$("#password").val()});$("#login-screen").hide();$("#login_spinner").show()})})});