{% extends "apps/report/report_base.html" %}
{% load comments %}
{% load thumbnail %}
{% load taggit_extras %}

{% block extrahead %}
<script>
    $(document).ready(function() {
        $("#button_block").hide();

        $("#tag").hide();
        $("#add_tag").click(function() {
            $("#tag").show();
        });
        $("#id_comment").focus(function() {
            $(this).animate({"height": "85px"}, "fast" );
            $("#button_block").slideDown("fast");
            return false;
        });
        $("#button_cancel").click(function() {
            $("#id_comment").animate({"height": "18px"}, "fast" );
            $("#button_block").slideUp("fast");
            return false;
        });
    });
</script>
{% endblock %}

{% block report_leftside %}
{% if messages %}
    {% for message in messages %}
        <div class="alert-message warning">
            <a class="close" href="#">Ã—</a>
            <p>
                <strong>{{ message }}</strong>
            </p>
        </div>
    {% endfor %}
{% endif %}

<ul class="tabs">
    <li class="active"><a href="/file/{{ result.id }}/show">Info</a></li>
    <li><a href="/file/{{ result.id }}/related">Related</a></li>
</ul>


{% if investigations %}
<div class="alert-message block-message info">
    <h3>Appears in the following investigations</h3>
    {% for investigation in investigations %}
        <a href="/investigation/{{ investigation.id }}" class="btn" style="margin-top:5px;">{{ investigation.title }}</a>
    {% endfor %}
</div>
{% endif %}
    <table style="border-image:none;">
	    <tr><td style="border-top:none;"><b>Type:</b></td><td style="border-top:none;">{{ result.filetype }}</td></tr>
		<tr><td style="border-top:none;"><b>Size:</b></td><td style="border-top:none;">{{ result.filesize }} bytes ({{ result.filesize|filesizeformat }})</td></tr>
		<tr><td style="border-top:none;"><b>md5:</b></td><td style="border-top:none;">{{ result.md5 }}</td></tr>
		<tr><td style="border-top:none;"><b>sha1:</b></td><td style="border-top:none;">{{ result.sha1 }}</td></tr>
		<tr><td style="border-top:none;"><b>sha256:</b></td><td style="border-top:none;">{{ result.sha256 }}</td></tr>
        <!-- <tr><td style="border-top:none;"><b>fuzzy:</b></td><td style="border-top:none;">{{ result.ctph }}</td></tr> -->
        <!--
        <tr><td><b>MHR</b></td>
        <td>
            {% if not mhr %}
	            <a href="/file/{{ result.id }}/malware/mhr?hash={{ result.sha1 }}">Check with MHR (Malware Hash Repository)</a><br>
	        {% else %}
	            {% if mhr.donotexist %}
		            <font color="green">No match in MHR:s malware repository</font><br>
	            {% else %}
	                <font color="red">{{ mhr.percent }}% chance this file is malware according to MHR</font><br>
	            {% endif %}
            {% endif %}
        </td></tr>
        -->
        <tr><td><b>Tags</b></td>
        <td>
        {% if result.tags.all %}
        {% for tag in result.tags.all %}
            <span class="label">{{ tag }}</span>
        {% endfor %}
        {% else %}
            <span class="quiet">No tags</span>
        {% endif %}
            {% ifequal user file.user %}
            <span id="add_tag" class="label success">Add +</span>
            <span id="tag">
            <form method="post" id="tag_form" action="/file/{{ result.id }}/tag">{% csrf_token %}
                <span class="left">{{ tagform.tags }}</span>
            </form>
        </span>
        {% endifequal %}
        </td>

        <tr><td><b>Shared</b></td>
            <td>
                {% for box in file.boxes.all %}
                    <span class="label notice">{{ box }}</span>
                {% endfor %}
            </td>
        </tr>
    </table>

{% if files %}
        <table border=0 class="noborder">
            <th>{{ files|length }} reporter{{ files|pluralize:"s"  }}</th>
            <th>filename</th>
            {% for n in files %}
                <tr>
                    <td width="200px">
                        <div class="avatar">
                            {% if n.user.profile.avatar %}
                                {% thumbnail n.user.profile.avatar "30x30" crop="center" as im %}
                                    <img class="avatar_thumb" src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}">
                                {% endthumbnail %}
                            {% else %}
                                {% thumbnail "img/avatar_placeholder.png" "30x30" crop="center" as im %}
                                    <img class="avatar_thumb" src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}">
                                {% endthumbnail %}
                            {% endif %}
                        </div>
                        <span class="threadTitle"><a href="/user/{{ n.user.id }}">{{ n.user.profile.name }}</a></span><br>
                        <span class="threadText">{{ n.time_created|timesince }} ago</span><br><br>
                        <td>{{ n.filename }}</td>
                </tr>
            {% endfor %}
        </table>
{% endif %}
{% endblock %}

{% block report_rightside %}
<h4>Discussion</h4>
<br>
    <div id="share">
        <form method="post" action="/newpost">{% csrf_token %}
            <textarea rows=1 id="id_comment" name="post" placeholder="Share your thoughts .."></textarea>
            <br><br>
            <div id="button_block">
                <input type="submit" class="btn success" id="button_submit" value="Post" />
                <input type="submit" class="btn" id='button_cancel' value="Cancel" />
                <input type="hidden" name="type" value="file" />
                <input type="hidden" name="id" value="{{ file.id }}" />
            </div>
        </form>
    </div>

{% if posts %}
    {% for post in posts %}
        <div class="avatar">
            {% if post.user.profile.avatar %}
                {% thumbnail post.user.profile.avatar "40x40" crop="center" as im %}
                    <img class="avatar_thumb" src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}">
                {% endthumbnail %}
            {% else %}
                {% thumbnail "img/avatar_placeholder.png" "40x40" crop="center" as im %}
                    <img class="avatar_thumb" src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}">
                {% endthumbnail %}
            {% endif %}
        </div>
        <div class="post_box">
            <a href="/user/{{ post.user.id }}"><strong>{{ post.user.profile.name }}</strong></a>
            <span class="quiet right">{{ post.time_created|timesince }} ago</span>
            <br>
            {{ post.content|linebreaksbr|escape }}
        </div>
    {% endfor %}
{% else %}
    <h6>No posts</h6>
{% endif %}

{% endblock %}
