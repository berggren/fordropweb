{% extends "apps/report/report_base.html" %}
{% load comments %}
{% load thumbnail %}
{% load taggit_extras %}

{% block extrahead %}
<script>
    $(document).ready(function() {
        $("#button_block").hide()
        $("#id_comment").focus(function() {
            $(this).animate({"height": "85px"}, "fast" );
            $("#button_block").slideDown("fast");
            return false;
        });
        $("#button_cancel").click(function() {
            $("#id_comment").animate({"height": "18px"}, "fast" );
            $("#button_block").slideUp("fast");
            return false;
        });
    });
</script>
{% endblock %}

{% block report_leftside %}
{% if messages %}
    {% for message in messages %}
        <div class="alert-message warning">
            <a class="close" href="#">Ã—</a>
            <p>
                <strong>{{ message }}</strong>
            </p>
        </div>
    {% endfor %}
{% endif %}

<!--<a href="javascript: history.go(-1)" style="margin-right:10px;" class="btn left">&laquo; Back</a><h3 class="inline">{{ result.sha1 }}</h3>-->
<ul class="tabs">
    <li class="active"><a href="/file/{{ result.id }}/show">Info</a></li>
    <li><a href="/file/{{ result.id }}/related">Related</a></li>
</ul>

<br><br><br>

{% if investigations %}
<div class="alert-message block-message info">
    <!-- <a class="close" href="#">&times;</a> -->
    <h3>Appears in the following investigations</h3>
    {% for investigation in investigations %}
        <a href="/investigation/{{ investigation.id }}" class="btn" style="margin-top:5px;">{{  investigation.title }}</a>
    {% endfor %}
</div>
{% endif %}

    <table border=0 class="noborder">
	    <tr><td><b>Type:</b></td><td>{{ result.filetype }}</td></tr>
		<tr><td><b>Size:</b></td><td>{{ result.filesize }} bytes ({{ result.filesize|filesizeformat }})</td></tr>
		<tr><td><b>md5:</b></td><td>{{ result.md5 }}</td></tr>
		<tr><td><b>sha1:</b></td><td>{{ result.sha1 }}</td></tr>
		<tr><td><b>sha256:</b></td><td>{{ result.sha256 }}</td></tr>
        <tr><td><b>MHR</b></td>
        <td>
            {% if not mhr %}
	            <a href="/file/{{ result.id }}/malware/mhr?hash={{ result.sha1 }}">Check with MHR (Malware Hash Repository)</a><br>
	        {% else %}
	            {% if mhr.donotexist %}
		            <font color="green">No match in MHR:s malware repository</font><br>
	            {% else %}
	                <font color="red">{{ mhr.percent }}% chance this file is malware according to MHR</font><br>
	            {% endif %}
            {% endif %}
        </td></tr>
    </table>

{% if files %}
        <table border=0 class="noborder">
            <th>{{ files|length }} reporter{{ files|pluralize:"s"  }}</th>
            <th>filename</th>
            {% for n in files %}
                <tr>
                    <td width="200px">
                        <div class="avatar">
                            {% if n.user.profile.avatar %}
                                {% thumbnail n.user.profile.avatar "30x30" crop="center" as im %}
                                    <img src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}">
                                {% endthumbnail %}
                            {% else %}
                                {% thumbnail "img/avatar_placeholder.png" "30x30" crop="center" as im %}
                                    <img src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}">
                                {% endthumbnail %}
                            {% endif %}
                        </div>
                        <span class="threadTitle"><a href="/user/{{ n.user.id }}">{{ n.user.profile.name }}</a></span><br>
                        <span class="threadText">{{ n.time_created|timesince }} ago</span><br><br>
                        <td>{{ n.filename }}</td>
                </tr>
            {% endfor %}
        </table>
{% endif %}
{% endblock %}

{% block report_rightside %}
<h4>Discussion</h4>
<!-- Comments -->
<br>
{% get_comment_list for result as comments %}
{% get_comment_form for result as form %}
<form method="post" action="/comments/post/">{% csrf_token %}
    <input type="hidden" name="next" value="/file/{{ result.id }}/show" />
        {% for hidden in form.hidden_fields %}
            {{ hidden }}
        {% endfor %}
        <textarea rows=1 id="id_comment" name="comment" placeholder="Say what you want to say .."></textarea>
        <br><br>
        <div id="button_block">
            <input type="submit" class="btn success" id="button_submit" value="Post" />
            <input type="submit" class="btn" id='button_cancel' value="Cancel" />
     </div>
</form>

{% if comments %}
    {% for comment in comments reversed %}
        <div class="comment-container">
            <div class="comment">
                <div class="avatar">
                    {% if comment.user.profile.avatar %}
                        {% thumbnail comment.user.profile.avatar "30x30" crop="center" as im %}
                            <img src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}">
                        {% endthumbnail %}
                    {% else %}
                        {% thumbnail "img/avatar_placeholder.png" "30x30" crop="center" as im %}
                            <img src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}">
                        {% endthumbnail %}
                    {% endif %}
                </div>
                <a href="/user/{{ comment.user.id }}">{{ comment.user.profile.name }}</a><br>
                <span class="quiet">{{ comment.submit_date|timesince }} ago</span><br>
                {{ comment.comment|linebreaksbr }}
                <br><br><hr>
            </div>
        </div>
    {% endfor %}
{% else %}
    <h6>No comments</h6>
{% endif %}
<!-- END comments -->

<h5>Tags</h5>
<form method="post" action="/file/{{ result.id }}/tag">{% csrf_token %}
<span class="left">{{ tagform.tags }}</span>
</form>
<br>
{% for tag in result.tags.all %}
    <span class="label">{{ tag }}</span>
{% endfor %}

{% endblock %}
